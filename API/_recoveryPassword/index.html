<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.js"
        integrity="sha512-RT3IJsuoHZ2waemM8ccCUlPNdUuOn8dJCH46N3H2uZoY7swMn1Yn7s56SsE2UBMpjpndeZ91hm87TP1oU6ANjQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>Recuperar senha de acesso</title>
</head>

<body onload='checkState()'>
    <div class='container' style="display: flex;justify-content: center;margin-top: 30px;flex-direction: column;">
        <div class='form'>
            <h3>Recuparação de senha</h3>
            <div>
                <label>Nova senha: <input type='password' id='password' /></label> <span>(ViewPassword - ícone)</span>
            </div>
            <br />
            <div>
                <label>Confirmar senha: <input type='password' id='confirmPassword' /></label> <span>(ViewPassword -
                    ícone)</span>
            </div>
            <br />
            <div style="visibility: hidden" id='token'>${token}</div>
            <button onclick='saveNewPassword()'>Alterar senha</button>
        </div>
    </div>


    <script>
        const checkState = async () => {
            const endpoint = location.href.split('/')[location.href.split('/').length - 1]
            await axios.get(`http://192.168.2.183:500/already-changed?endpoint=` + endpoint)
                .then(res => {
                    window.alert(res.data)
                    if (res.data) {
                        document.getElementsByClassName('container')[0].innerHTML = `
                        <h2 style="margin: auto;">Senha alterada com sucesso!</h2>
                        <br/>
                        <h2 style="margin: auto;">Para trocar de senha, solicite novamente.</h2>
                    `
                    }
                })
                .catch(err => {
                    console.log(err)
                    window.alert('Erro ao alterar senha!')
                })
        }

        const saveNewPassword = async () => {
            const password = document.querySelector('#password').value
            const confirmPassword = document.querySelector('#confirmPassword').value
            const token = document.querySelector('#token')

            console.log(password)
            console.log(confirmPassword)
            console.log(token)

            if (password.length < 8) {
                window.alert('Senha muito curta!')
                return
            }

            if (password != confirmPassword) {
                window.alert('As senha são diferentes!')
                return
            }

            // TODO Tornar o ip dinâmico
            await axios.put(`http://192.168.2.183:500/recovery-password`, { password, token })
                .then(res => {
                    document.getElementsByClassName('container')[0].innerHTML = `
                        <h2 style="margin: auto;">Senha alterada com sucesso!</h2>
                        <br/>
                        <h2 style="margin: auto;">Para trocar de senha, solicite novamente.</h2>
                    `
                })
                .catch(err => {
                    console.log(err)
                    window.alert('Erro ao alterar senha!')
                })
        }
    </script>
</body>

</html>